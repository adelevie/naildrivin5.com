<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Naildrivin' &#10106;]]></title>
  <link href="http://www.naildrivin5.com/atom.xml" rel="self"/>
  <link href="http://www.naildrivin5.com/"/>
  <updated>2012-07-29T10:57:11-04:00</updated>
  <id>http://www.naildrivin5.com/</id>
  <author>
    <name><![CDATA[David Bryant Copeland]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[&dagger; Six languages to master]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/07/29/six-languages-to-master.html"/>
    <updated>2012-07-29T10:48:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/07/29/six-languages-to-master</id>
    <content type="html"><![CDATA[<p><a href="https://michaelochurch.wordpress.com/2012/07/27/six-languages-to-master/">This</a> post, by <a href="https://michaelochurch.wordpress.com/">Michael O Church</a> is an excellent post on being a better programmer and full of a lot more awesome
than the title implies.  You need to read the entire thing. After he makes the case for which five programming languages to learn, the best stuff starts when he makes his case for the sixth:</p>

<blockquote><p>The sixth is one that very few programmers are willing to use in source code: English.</p></blockquote>


<p>He rightly defends comments and documentation:</p>

<blockquote><p>Most problems are custom problems that require documentation of what is being solved, why, and how. People need to know, when they read code, what they’re looking at; otherwise, they’re going to waste a massive amount of time focusing on details that aren’t relevant.</p></blockquote>


<p>And makes very salient points about depending on IDEs to develop.  This is one of many, but my person favorite:</p>

<blockquote><p>If you’re IDE-dependent, you can’t write code outside of a corporate environment, because when you go home, you don’t have a huge support team to set the damn thing up.</p></blockquote>


<p>Really great read.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[&#10106;&#10144; A world without nil]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/07/25/a-world-without-nil.html"/>
    <updated>2012-07-25T15:39:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/07/25/a-world-without-nil</id>
    <content type="html"><![CDATA[<p><a href="http://www.naildrivin5.com/blog/2012/07/17/adventures-in-functional-programming-with-ruby.html">Previously</a>, we saw how just using functions in Ruby, we could create a lot of powerful code.  Let&#8217;s continue the theme of &#8220;programming with constraints&#8221; and try to solve an actual problem. <code>nil</code>.</p>

<!-- more -->


<h2>Is <code>nil</code> a problem?</h2>

<p><code>nil</code> creates problems in code clarity and revealing programmer intent.  <code>nil</code> means
&#8220;no value&#8221; sometimes, but other times it means <code>false</code>.  Other times it means &#8220;the developer didn&#8217;t think of the proper default
for a value&#8221;.  Rails migrations, by default, allow database columns to be nullable.  This is often not correct, and by making it
the default, you cannot tell the difference between &#8220;the business requires that this field be nullable&#8221; and &#8220;the developer forgot
to consider the nullability of this column&#8221;.</p>

<p>The problems manifest when you see a test failure or production error where something is <code>nil</code> that you weren&#8217;t expecting.  Now
you have to figure out if that value could be <code>nil</code> (and the original developer missed the edge case) or if it should <em>never</em> be
<code>nil</code>, and you have a more serious problem in either your data, business logic, or worse.</p>

<p>The reason this becomes complex isn&#8217;t necessarily the concept of &#8220;no such value&#8221; (though this <em>is</em> a bit of a problem), but the way in which <code>nil</code> is treated by the language.  In Ruby, <code>nil</code> is the only instance of <code>NilClass</code> and has the following magical properties that cannot be bestowed on any other object:</p>

<ul>
<li>it is &#8220;falsey&#8221; (a trait shared with only one other value, <code>false</code>, the sole value of <code>FalseClass</code>)</li>
<li>it is the default value of every variable</li>
</ul>


<p>Because of these two things, we use it all over the place to represent &#8220;no value&#8221;, and our code is littered with:</p>

<ul>
<li><code>do_something if value.nil?</code></li>
<li><code>foo ||= {}</code></li>
<li><code>Array(some_list).each</code></li>
</ul>


<p>And so forth.  Avdi Grimm gave <a href="http://confreaks.com/videos/763-rubymidwest2011-confident-code">a talk at Ruby Midwest</a> called &#8220;Confident Ruby&#8221; that deals, in part, with nil and how to avoid it.  Things like <code>Array()</code>, <code>String()</code>, and null objects are good techniques.</p>

<p>But let&#8217;s take a different approach.  What if there were no such thing as <code>nil</code>, and the language didn&#8217;t support it?</p>

<h2>Can you imagine? A world without <code>nil</code>?</h2>

<p><img class="right" src="http://25.media.tumblr.com/tumblr_ltbtgjU70B1qztjn5o1_500.jpg" width="275"></p>

<p>Suppose there were no such thing as <code>nil</code> in Ruby.  Every variable would require that a value be assigned to it at declare time, and the runtime would raise an exception if you tried to use a variable/parameter/etc. without a value.</p>

<p>How would that change the way we code?</p>

<p>Of course, we could re-invent it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">NilClass</span>
</span><span class='line'>  <span class="vc">@@nil</span> <span class="o">=</span> <span class="no">NilClass</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new</span>
</span><span class='line'>    <span class="vc">@@nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">nil?</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">BasicObject</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">nil?</span>
</span><span class='line'>    <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vg">$nil</span> <span class="o">=</span> <span class="no">NilClass</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<p>This gives us a value that means &#8220;no value&#8221;, but without the magic provided by the language, what good is it?</p>

<p>Let&#8217;s return to our domain from the previous post, where we want to make a system that manages users in a database.  Since we now have our fully armed and operational object-oriented programming language, we might be inclined to make a <code>Person</code> class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:birthdate</span><span class="p">,</span> <span class="ss">:gender</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:id</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class='line'>    <span class="vi">@birthdate</span> <span class="o">=</span> <span class="n">birthdate</span>
</span><span class='line'>    <span class="vi">@gender</span> <span class="o">=</span> <span class="n">gender</span>
</span><span class='line'>    <span class="vi">@title</span> <span class="o">=</span> <span class="n">title</span>
</span><span class='line'>    <span class="vi">@id</span> <span class="o">=</span> <span class="nb">id</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember, we don&#8217;t have <code>nil</code>, so we don&#8217;t have a default value for any variable - we must assign one explicitly or we&#8217;ll get runtime errors.  Given the code above, this shouldn&#8217;t be a problem, since we assign values to our ivars when they are declared.</p>

<p>If you recall, however, we have two optional values in our <code>Person</code>: <code>title</code>, and <code>id</code>. <code>title</code> is simply optional - a person might not have a title - while <code>id</code> will only be populated if the person has been stored in the database.  How can we model this?</p>

<h2>Generic optional values?</h2>

<p>Scala (a statically-typed functional/OO language that runs on the JVM), &#8220;solves&#8221; this by creating an <code>Option</code> type that makes explicit the concept of an optional value<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>.  In Ruby, it would look like this:</p>

<figure class='code'><figcaption><span>An optional type</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># The base class that also serves as a factory for instances</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Optional</span>
</span><span class='line'>  <span class="c1"># Optional value that has a value</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">some</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Some</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Optional value with NO value</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">none</span>
</span><span class='line'>    <span class="no">None</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Some</span> <span class="o">&lt;</span> <span class="no">Optional</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:value</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@value</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exists?</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">None</span> <span class="o">&lt;</span> <span class="no">Optional</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">exists?</span>
</span><span class='line'>    <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use it like so:</p>

<figure class='code'><figcaption><span>Using our optional type</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dave</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Dave&quot;</span><span class="p">,</span><span class="s2">&quot;1972-01-01&quot;</span><span class="p">,</span><span class="ss">:male</span><span class="p">,</span><span class="no">Optional</span><span class="o">.</span><span class="n">none</span><span class="p">,</span><span class="no">Optional</span><span class="o">.</span><span class="n">none</span><span class="p">)</span>
</span><span class='line'><span class="n">rudy</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Rudy&quot;</span><span class="p">,</span><span class="s2">&quot;2001-01-01&quot;</span><span class="p">,</span><span class="ss">:male</span><span class="p">,</span><span class="no">Optional</span><span class="o">.</span><span class="n">some</span><span class="p">(</span><span class="s2">&quot;cat&quot;</span><span class="p">),</span><span class="no">Optional</span><span class="o">.</span><span class="n">some</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">salutation</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">exists?</span>
</span><span class='line'>      <span class="n">title</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">name</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">name</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, we&#8217;ve replaced what would be a call to <code>.nil?</code> in regular Ruby with a call to <code>.exists?</code> in our nil-less Ruby.  Is this really any better?  We could wrap the logic of &#8220;do one thing if there&#8217;s a value, do another if there isn&#8217;t&#8221; into a method on <code>Optional</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Some</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">with_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">,</span><span class="o">&amp;</span><span class="n">_</span><span class="p">)</span>
</span><span class='line'>    <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">None</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">with_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="n">block</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We could then implement <code>salutation</code> like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">salutation</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">with_value</span><span class="p">(</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="p">{</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">name</span> <span class="p">},</span>
</span><span class='line'>      <span class="o">-&gt;</span>        <span class="p">{</span> <span class="nb">name</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yech.  We might be able to play some syntax games and clean this up, but this is <em>not</em> an improvement.  <code>if/else</code> statements are
easy to understand and with the magic of <code>nil</code>, the logic is pretty straightforward:</p>

<figure class='code'><figcaption><span>using nil&#8217;s falsiness</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">salutation</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">self</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Optional</code>, as we&#8217;ve defined it, is just a degenerate implementation of <code>nil</code> that has a terrible API<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>.  It <em>does</em> have the advantage of not being magic - we are required to provide a value for every variable, which is nice - but can we do better?</p>

<h2>Solving the problem in front of us</h2>

<p>Let&#8217;s step back and just try solving the problem in front of us, instead of adding the general concept of optional values.  What if we used the type system more explicitly?</p>

<p>Suppose we define <code>Person</code> to be only the <em>required</em> values, i.e. the bare essence of a person in our system, and then create
mixins for the optional values.  We could make a mixin like <code>Stored</code> act as both a &#8220;tag&#8221; for an object that is stored in the
database, and as the location for related code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="c1"># Every person must have a name, birthdate, and gender.</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:birthdate</span><span class="p">,</span> <span class="ss">:gender</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class='line'>    <span class="vi">@birthdate</span> <span class="o">=</span> <span class="n">birthdate</span>
</span><span class='line'>    <span class="vi">@gender</span> <span class="o">=</span> <span class="n">gender</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Stored</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:id</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Titled</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:title</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that we don&#8217;t make <code>id</code> or <code>title</code> mutable; they are still read-only fields.  So, how do they get set?  We tightly couple
<code>Person</code> with these new modules and set the fields there.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">title</span><span class="o">=</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@title</span> <span class="o">=</span> <span class="n">title</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">Titled</span><span class="p">)</span> <span class="c1"># THIS object is now a Titled, but other Person instances are not</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">id</span><span class="o">=</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@id</span> <span class="o">=</span> <span class="nb">id</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">Stored</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that if we wanted to maintain total immutability, we would need to jump through a few hoops:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">with_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">dup</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>      <span class="n">person</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">Titled</span><span class="p">)</span>
</span><span class='line'>      <span class="n">person</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@title&quot;</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In either case, we end up with an instance that has mixed in <code>Titled</code> and absolutey has a value for <code>title</code>.</p>

<p>How would this affect our <code>salutation</code> method?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">salutation</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Titled</span><span class="p">)</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">name</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve replaced a generic check - for <code>nil</code> - with a specific check - for being <code>Titled</code>.  This may not seem like an improvement, but I&#8217;d argue that it makes our domain a bit richer and more intention-revelaing.  It turns an implementation decsion (treating <code>nil</code> as not having a title) into something explicit. And, at the end of the day, if we need logic based on the existence of a value, well, we&#8217;re going to need to use <code>if</code> statements.</p>

<p>Or are we?</p>

<p>Before we answer that, it&#8217;s worth noting that although <code>Titled</code> is specific to our <code>Person</code> class, <code>Stored</code> is a more generic concept that could be broadly used to explicitly call out records not stored in the database.  Imagine an <code>update</code> method like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span class='line'>  <span class="k">raise</span> <span class="no">NotStoredError</span> <span class="k">unless</span> <span class="n">record</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Stored</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That reads a lot better to me than a <code>nil</code> check<sup id='fnref:3'><a href='#fn:3' rel='footnote'>3</a></sup>.  It also abstracts away the way in which we know that a record is stored, but without requiring a common superclass.</p>

<p>Back to our <code>if</code> statement.  We have a business rule based on the existence of a value, so it seems we just have to live with the conditional logic, right?  Not exactly.  What if both <code>Person</code> and <code>Titled</code> implemented <code>salutation</code>?</p>

<p>Person would use the &#8220;default if no title&#8221; version, because a raw <code>Person</code> has no title:</p>

<figure class='code'><figcaption><span>Person&#8217;s default implementation of salutation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">salutation</span>
</span><span class='line'>    <span class="nb">name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once <code>Titled</code> is mixed in, we know that we absolutely have a title, so we override it with the correct logic given a title:</p>

<figure class='code'><figcaption><span>Titled overrides it, since it knows it has a value</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Titled</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">salutation</span>
</span><span class='line'>    <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="k">super</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, <em>this</em> is interesting.  We&#8217;re using polymorphism and inheritance as a way to avoid <code>if</code> statements.  If we&#8217;d used <code>nil</code> to
represent &#8220;no title&#8221;, we&#8217;d be stuck with conditional logic.  The added constraint of programming without <code>nil</code> has forced us to
get creative and resulted in a cleaner solution.</p>

<p>We&#8217;ve now used the type system to create an explicit description of our domain, and we didn&#8217;t need <code>nil</code>.  Of course, a type that has a lot of optional values will require a lot of these sorts of modules, and it could get ugly.  This might be a good thing.</p>

<p>Now that we can handle optional values in our data structures, what about containers?</p>

<h2>Optional values in container classes</h2>

<p>I see a lot of code using <code>first</code> or <code>last</code> on an array as a shortcut for checking if the array is empty and, if not, getting the first or last element respectively.  Obviously, this would have to stop, but what about so-called &#8220;sparse arrays&#8221; where some indeces contain <code>nil</code> values?  Dealing with this cleanly is not simple given the currently API of <code>Array</code>.  Of course, if the language never had <code>nil</code>, you could imagine that <code>Array</code> would have <em>some</em> facility for dealing with this.  On idea would be that each accessor method would accept an optional block that would be run if there were no value, so that the caller could provide a default:</p>

<figure class='code'><figcaption><span>Imaginary Array API when we don&#8217;t have nil</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">list</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>                               <span class="c1"># =&gt; raises IndexError</span>
</span><span class='line'><span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">{</span> <span class="o">|</span><span class="n">index</span><span class="o">|</span> <span class="s2">&quot;default</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span> <span class="c1"># =&gt; default0</span>
</span><span class='line'><span class="n">list</span><span class="o">.</span><span class="n">first</span> <span class="p">{</span> <span class="s2">&quot;default&quot;</span> <span class="p">}</span>              <span class="c1"># =&gt; default</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we&#8217;re talking about containers, however, we&#8217;d need to be able to model &#8220;there is no value at this location&#8221; more explicitly.  Since <em>this</em> actually <em>is</em> a generic problem, we can bring back our <code>Optional</code> class to handle it.  We could assume that the <code>Array</code> class bakes in the use of <code>Optional</code>, but a) the API would be somewhat inconvienient and b) it doesn&#8217;t help us in the real world.  What if we created a mix-in that we could use for <code>Array</code> instances that contained optional values?</p>

<figure class='code'><figcaption><span>Mix-in to make it easier to work with Arrays that contain Optional values</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">OptionalValuesArray</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Set a value directly</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">[]=</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="no">Optional</span><span class="o">.</span><span class="n">some</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># clear the value at this index</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">clear_value</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="no">Optional</span><span class="o">.</span><span class="n">none</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># get the value or, if it&#39;s not there, call the block</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span><span class="o">[</span><span class="n">index</span><span class="o">].</span><span class="n">with_value</span><span class="p">(</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">value</span> <span class="p">},</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="p">()</span>      <span class="p">{</span> <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># iterate over only the values that exist</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">each_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="n">optional</span><span class="p">)</span>
</span><span class='line'>      <span class="n">optional</span><span class="o">.</span><span class="n">with_value</span><span class="p">(</span>
</span><span class='line'>        <span class="o">-&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>        <span class="o">-&gt;</span><span class="p">()</span>      <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Map only the values that exist</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">map_values</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[].</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_array</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">each_value</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>        <span class="n">new_array</span> <span class="o">&lt;&lt;</span> <span class="n">value</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">optional_values_allowed</span> <span class="o">=</span> <span class="o">[].</span><span class="n">extend</span><span class="p">(</span><span class="no">OptionalValuesArray</span><span class="p">)</span>
</span><span class='line'><span class="n">no_optional_values</span> <span class="o">=</span> <span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This API might not be &#8220;right&#8221;, but we can see that, without <code>nil</code>, we have to be explicit about which arrays can be missing
values and which cannot.  That makes our code more intention-revealing.  If Ruby really didn&#8217;t have <code>nil</code>, I would expect the
Array class to better &#8220;bake-in&#8221; this concept so that the API was clean and easy.</p>

<p><code>Hash</code>, on the other hand, comes built-in with everything we need to avoid <code>nil</code>, namely the <code>fetch</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="ss">:bar</span><span class="p">,</span> <span class="ss">:baz</span> <span class="o">=&gt;</span> <span class="ss">:quux</span> <span class="p">}</span>
</span><span class='line'><span class="nb">hash</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span>                   <span class="c1"># =&gt; :bar</span>
</span><span class='line'><span class="nb">hash</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:blah</span><span class="p">)</span>                  <span class="c1"># =&gt; raises IndexError</span>
</span><span class='line'><span class="nb">hash</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:blah</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span> <span class="s2">&quot;crud&quot;</span> <span class="p">}</span> <span class="c1"># =&gt; &quot;crud&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>By using <code>fetch</code>, we can be very clear about what we want to do.  Without a block, we are getting the value for a key that must exist.  <em>With</em> a block we indicate that we&#8217;re getting a value for a key that is optional&#8230;and we must specify the value to use if it&#8217;s missing.</p>

<p>An alternative is to specify a block that provides default values, and then use <code>[]</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="o">|</span> <span class="ss">:default_value</span> <span class="p">}</span>
</span><span class='line'><span class="nb">hash</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:bar</span>
</span><span class='line'><span class="nb">hash</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>  <span class="c1"># =&gt; :bar</span>
</span><span class='line'><span class="nb">hash</span><span class="o">[</span><span class="ss">:blah</span><span class="o">]</span> <span class="c1"># =&gt; :default_value</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another way in which we use <code>nil</code> in a <code>Hash</code> is in the &#8220;options hash&#8221; pattern where we can parameterize a method call, typically
omitting keys where we want to use the default value provided by the API.  In this case, we use <code>nil</code> to mean &#8220;don&#8217;t use the
default, but omit the value entirely&#8221;.</p>

<p>For example, in Rails 3, we can use <code>respond_with</code> to send an object to the caller in the
controller.  By default, the HTTP location header is set by examining the type of the object and getting a URL for it.
<code>respond_with</code> takes an options hash and, if we wish to avoid setting this header, we must set <code>:location</code> to <code>nil</code>:</p>

<figure class='code'><figcaption><span>Using nil to &#8220;unset&#8221; an option</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SomeController</span>
</span><span class='line'>  <span class="n">respond_to</span> <span class="ss">:json</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">record</span> <span class="o">=</span> <span class="n">create_record_somehow</span>
</span><span class='line'>    <span class="n">respond_with</span> <span class="n">record</span><span class="p">,</span> <span class="ss">:location</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing this without <code>nil</code> is trickier, and I think it requires a small change in how we design APIs using the options hash.
The result, again, will be more intention-revelaing code.  Instead of using <code>nil</code> for &#8220;don&#8217;t set the location header&#8221;, we would
set an option that indicates that more clearly:</p>

<figure class='code'><figcaption><span>Imagined options for respond_with</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SomeController</span>
</span><span class='line'>  <span class="n">respond_to</span> <span class="ss">:json</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">record</span> <span class="o">=</span> <span class="n">create_record_somehow</span>
</span><span class='line'>    <span class="n">respond_with</span> <span class="n">record</span><span class="p">,</span> <span class="ss">:set_location</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This would even improve the implementation of <code>respond_with</code> as well:</p>

<figure class='code'><figcaption><span>Imagined implementation of respond_with if nil were not an option</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">respond_with</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>  <span class="n">options</span><span class="o">[</span><span class="ss">:location</span><span class="o">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:location</span><span class="p">)</span> <span class="p">{</span> <span class="n">default_location_for</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:set_location</span><span class="o">]</span>
</span><span class='line'>    <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Location&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:location</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># and whatever else</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, the absence of <code>nil</code> is making our code a <em>bit</em> longer, but much more intention-revealing and explicit.</p>

<p>In reality, though, <code>nil</code> exists and is used in many places.  Can we take anything from this to the real world?</p>

<h2>Back to reality</h2>

<p>First and foremost, I would suggest that you design APIs in a way that <code>nil</code> is not required nor used.  Methods that return
collections should return an empty version instead of <code>nil</code>.  Method parameters should not allow <code>nil</code> to be passed in for any
value, and should use an options has for optional values.</p>

<p>Not every API is written this way, and to deal with them, there are a few handy methods provided by Ruby that can help:</p>

<ul>
<li><code>String()</code> - converts <code>nil</code> to the empty string, and converts any string to itself.  Wrap a possibly-<code>nil</code> string in this and you avoid a <code>nil</code> check. (ActiveSupport&#8217;s <code>#present?</code> is a way to do this, too, but <code>String()</code> works everywhere in Ruby)</li>
<li><code>Array()</code> - converts <code>nil</code> to an empty array and converts an array to itself.  Perfect for dealing with pesky APIs that insist on returning <code>nil</code> instead of an empty array.</li>
<li><code>Hash[Array()]</code> - by combining <code>Hash#[]</code> and <code>Array()</code>, we can convert nil to an empty hash and a hash to itself.  <code>Array()</code> will turn a <code>Hash</code> into a two-dimensional array, and <code>Hash#[]</code> will turn a two-dimensional array back into a <code>Hash</code>.  Since <code>Array()</code> turns <code>nil</code> into an empty array, <code>Hash[Array(nil)]</code> returns an empty has.  Ruby really should include a method named <code>Hash()</code> that does this, but it doesn&#8217;t.</li>
</ul>


<p>Beyond this, <a href="http://en.wikipedia.org/wiki/Null_Object_pattern">null objects</a> are a useful pattern for encapsulating logic of the type &#8220;do this if some value is nil&#8221;, and the <a href="http://api.rubyonrails.org/classes/Object.html#method-i-try"><code>try</code></a>
method in Rails is also very useful.</p>

<p>It&#8217;s still interesting to think about a world without <code>nil</code>. Without it, we can still handle the absence of values in objects, as well as containers, and our code is more intentional-revelaing.  Why <em>do</em> we need <code>nil</code>?</p>

<hr />

<div class="footnotes">
    <ol>
        <li id='fn:1'>The JVM still allows <code>null</code> and so does Scala, so <code>Option</code> only provides a way to express optional types more clearly; <code>null</code> is still there and is the default value of variables that aren&#8217;t given an initial value. <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>It&#8217;s worth pointing out that in Scala, <code>Option</code> is a lot more useful, because <code>null</code> has no such magical properties on the JVM like it does in Ruby. <a href='#fnref:2' rev='footnote'>↩</a></li><li id='fn:3'>I realize that Active Record encapsulates this concept in <code>new_record?</code>, but a) we&#8217;re in an imaginary domain without Active Record and b) that Active Record encapsulates the <code>nil</code> check gives more credence that doing so is a good idea in general. <a href='#fnref:3' rev='footnote'>↩</a></li>
    </ol>
</div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[&dagger; Slides from my OSCON talk]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/07/19/slides-from-my-oscon-talk.html"/>
    <updated>2012-07-19T15:28:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/07/19/slides-from-my-oscon-talk</id>
    <content type="html"><![CDATA[<script async class="speakerdeck-embed" data-id="500887bdded00e000201b1c3" data-ratio="1.7444633730834753"
src="http://www.naildrivin5.com//speakerdeck.com/assets/embed.js"></script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[&#10106;&#10144; Adventures in functional programming with Ruby]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/07/17/adventures-in-functional-programming-with-ruby.html"/>
    <updated>2012-07-17T11:33:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/07/17/adventures-in-functional-programming-with-ruby</id>
    <content type="html"><![CDATA[<p>The following is an aimless journey through a degenerate form of Ruby, in an effort to learn a bit more about functional programming, simplicity, and API design.</p>

<p>Suppose that the only way we have to organize code in Ruby is to make lambdas, and the only way we have to structure data are arrays:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">square</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="p">}</span>
</span><span class='line'><span class="n">square</span><span class="o">.</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># =&gt; 16</span>
</span><span class='line'>
</span><span class='line'><span class="n">person</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Dave&quot;</span><span class="p">,</span><span class="ss">:male</span><span class="o">]</span>
</span><span class='line'><span class="n">print_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">((</span><span class="nb">name</span><span class="p">,</span><span class="n">gender</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> is a </span><span class="si">#{</span><span class="n">gender</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">print_person</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the most bare-bones essence of functional programming: all we have is functions.   Let&#8217;s write some real-ish code this way and see how far we get before it starts
becoming painful.</p>

<!-- more -->


<p>Suppose we want to manipulate a database of people, and someone has provided us a few functions to interact with a data store.   We want to use these to add a UI and some validations.</p>

<p>Here&#8217;s how we interact with our data store:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span> <span class="c1"># =&gt; returns an id</span>
</span><span class='line'><span class="n">update_person</span><span class="o">.</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span><span class="n">new_birthdate</span><span class="p">,</span><span class="n">new_gender</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'><span class="n">delete_person</span><span class="o">.</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'><span class="n">fetch_person</span><span class="o">.</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="c1"># =&gt; returns the name, birthdate, and gender as an array</span>
</span></code></pre></td></tr></table></div></figure>


<p>First, we need to be able to add a person to our database, along with some validations.  We&#8217;ll get this data from user input (we can assume that <code>puts</code> and <code>gets</code> are built-ins that work as expected):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Name?&quot;</span>
</span><span class='line'><span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Birthdate?&quot;</span>
</span><span class='line'><span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Gender?&quot;</span>
</span><span class='line'><span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need a function to do our validations and add a person to the database.  What might it look like?  It should accept the attributes of a person and return
either an id (on successfully validation and insertion), or an error message, representing what went wrong.   Since we don&#8217;t have exceptions or hashes - just arrays -
we&#8217;re going to have to get creative.</p>

<p>Let&#8217;s create a convention in our system that every business logic methods returns an array of size 2.  The first element is the return value on success, and
the second element is an error message on failure.  The presence or absence of data in one of these slots indicates the result.</p>

<p>Now that we&#8217;ve sorted out what we accept as arguments and what we&#8217;re going to return, let&#8217;s write our function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Name is required&quot;</span><span class="o">]</span>                  <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Birthdate is required&quot;</span><span class="o">]</span>             <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">birthdate</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender is required&quot;</span><span class="o">]</span>                <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">gender</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender must be &#39;male&#39; or &#39;female&#39;&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">gender</span> <span class="o">!=</span> <span class="s1">&#39;male&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">gender</span> <span class="o">!=</span> <span class="s1">&#39;female&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">id</span> <span class="o">=</span> <span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>
</span><span class='line'>  <span class="o">[[</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="nb">id</span><span class="o">]</span><span class="p">,</span><span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you aren&#8217;t familiar with <code>String()</code>, it is a function that coalesces nil to the empty string, so we don&#8217;t have to check for both.</p>

<p>With this function, what we&#8217;d like to do is call it in a loop until the user has provided correct input, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">invalid</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="k">while</span> <span class="n">invalid</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Name?&quot;</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Birthdate?&quot;</span>
</span><span class='line'>  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Gender?&quot;</span>
</span><span class='line'>  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span>
</span><span class='line'>  <span class="n">result</span> <span class="o">=</span> <span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Successfully added person </span><span class="si">#{</span><span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">invalid</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Problem: </span><span class="si">#{</span><span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, we never said anything about <code>while</code> loops :)  Suppose we don&#8217;t have them.</p>

<h2>Loops are just functions (called recursively)</h2>

<p>To loop, we simply wrap our code in a function and call it recursively until we achieve the desired result.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Name?&quot;</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Birthdate?&quot;</span>
</span><span class='line'>  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Gender?&quot;</span>
</span><span class='line'>  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span>
</span><span class='line'>  <span class="n">result</span> <span class="o">=</span> <span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Successfully added person </span><span class="si">#{</span><span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Problem: </span><span class="si">#{</span><span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">person</span> <span class="o">=</span> <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can envision that our code is going to have a lot of <code>if result[1] == nil</code> in it, so let&#8217;s wrap it in a function.
The great thing about functions is that they allow us to re-use structure, as opposed to logic.  The structure here is
checking for an error and doing one thing on success and another on error.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">handle_result</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">on_success</span><span class="p">,</span><span class="n">on_error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">on_success</span><span class="o">.</span><span class="p">(</span><span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">on_error</span><span class="o">.</span><span class="p">(</span><span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, our <code>get_new_person</code> function abstracts away the error handling:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Name?&quot;</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Birthdate?&quot;</span>
</span><span class='line'>  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Gender?&quot;</span>
</span><span class='line'>  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">result</span> <span class="o">=</span> <span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">handle_result</span><span class="o">.</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="p">((</span><span class="nb">id</span><span class="p">,</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully added person </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="o">[</span><span class="nb">id</span><span class="p">,</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="nb">id</span><span class="o">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Problem: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">person</span> <span class="o">=</span> <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice what the use of <code>handle_result</code> allows us to explicitly name variables, instead of using Array de-referencing.  Not only can we name <code>error_message</code>, but, using Ruby&#8217;s
array-extraction syntax, we can &#8220;explode&#8221; our person array into its attributes via the <code>((id,name,birthdate,gender))</code> syntax.</p>

<p>So far, so good.  This code is probably a bit weird looking, but it&#8217;s not terribly verbose, or complex.</p>

<h2>Clean code uses more functions.</h2>

<p>One thing that might seem odd is that our person has no real structure or formal definition.  We simply have an array, and a
convention that the first element is the name, second element is birthdate, etc.  Our domain is pretty simple as-is, but let&#8217;s
suppose we want to add a new field: title.  What happens to our code when we do this?</p>

<p>Our database team delivers new versions of <code>insert_person</code> and <code>update_person</code> to us:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'><span class="n">update_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We then have to update our <code>add_person</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Name is required&quot;</span><span class="o">]</span>                  <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Birthdate is required&quot;</span><span class="o">]</span>             <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">birthdate</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender is required&quot;</span><span class="o">]</span>                <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">gender</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender must be &#39;male&#39; or &#39;female&#39;&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">gender</span> <span class="o">!=</span> <span class="s1">&#39;male&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">gender</span> <span class="o">!=</span> <span class="s1">&#39;female&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">id</span> <span class="o">=</span> <span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">[[</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="o">]</span><span class="p">,</span><span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And, since we use these extractions in <code>get_new_person</code>, <strong>that</strong> has to change, too.  Ugh:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Name?&quot;</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Birthdate?&quot;</span>
</span><span class='line'>  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Gender?&quot;</span>
</span><span class='line'>  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Title?&quot;</span>
</span><span class='line'>  <span class="n">title</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">result</span> <span class="o">=</span> <span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">handle_result</span><span class="o">.</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="p">((</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully added person </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="o">[</span><span class="nb">id</span><span class="p">,</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="o">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Problem: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the very definition of high-coupling.  <code>get_new_person</code> really shouldn&#8217;t care about the particular fields of a person; it
should simply read them in, and then pass them to <code>add_person</code>.  Let&#8217;s see if we can make that happen by extracting some of this code into new functions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">read_person_from_user</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Name?&quot;</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Birthdate?&quot;</span>
</span><span class='line'>  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Gender?&quot;</span>
</span><span class='line'>  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Title?&quot;</span>
</span><span class='line'>  <span class="n">title</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="o">[</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">person_id</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span> <span class="nb">id</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">handle_result</span><span class="o">.</span><span class="p">(</span><span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">read_person_from_user</span><span class="o">.</span><span class="p">())</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully added person </span><span class="si">#{</span><span class="n">person_id</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">person</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Problem: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve now abstracted the way in which we store a person into two functions: <code>read_person_from_user</code> and <code>person_id</code>.  At this
point, <code>get_new_person</code> will not need to change if we add more fields to a person.</p>

<p>If you&#8217;re confused about the use of <code>*</code> in this code, here&#8217;s a brief explanation:  <code>*</code> allows us to treat an array as a list of arguments and vice versa.  In <code>person_id</code>, we
use the parameter list <code>*_,id</code>, which tells Ruby to place all arguments to the function, save the last, into the variable <code>_</code> (so-named because we don&#8217;t care about its value),
and place the last argument in the variable <code>id</code>.  This only works in Ruby 1.9; in 1.8 only the last argument of a function may use the <code>*</code> syntax.  Further, when we call
<code>add_person</code>, we use the <code>*</code> on the results of <code>read_person_from_user</code>.  Since <code>read_person_from_user</code> returns an array, we want to treat that array as if it were an argument
list, since <code>add_person</code> accepts explicit arguments.  The <code>*</code> does that for us.  Nice!</p>

<p>Back to our code, you&#8217;ll note that we still have coupling between <code>read_person_from_user</code> and <code>person_id</code>.  They both are intimate with how we store a person in an array.
Further, if we added new features to actually <em>do</em> something with our people database, we can envision more methods coupled to this array-based format.</p>

<p>We need some sort of data structure.</p>

<h1>Data structures are just functions</h1>

<p>In non-degenerate Ruby, we&#8217;d probably make a class at this point, or at least us a <code>Hash</code>, but we don&#8217;t have access to those
here.  Can we make a real data structure just using functions?  It turns out we can, if we create a function that treats its first argument as an attribute of our data
structure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">new_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">id</span>        <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:id</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">name</span>      <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:name</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">birthdate</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:birthdate</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">gender</span>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:gender</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">title</span>     <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:title</span>
</span><span class='line'>    <span class="kp">nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dave</span> <span class="o">=</span> <span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="s2">&quot;Dave&quot;</span><span class="p">,</span><span class="s2">&quot;06-01-1974&quot;</span><span class="p">,</span><span class="s2">&quot;male&quot;</span><span class="p">,</span><span class="s2">&quot;Baron&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">dave</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>   <span class="c1"># =&gt; &quot;Dave&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">dave</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="c1"># =&gt; &quot;male&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>new_person</code> acts like a constructor, but instead of returning an object (which don&#8217;t exist for us), we return a function that, when called, can tell us the values of the
various attributes of our person.  We explicitly itemize the possible attributes, so we have a fairly firm definition of what the type of a person is.</p>

<p>Compare this to a class that does the same thing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:birthdate</span><span class="p">,</span> <span class="ss">:gender</span><span class="p">,</span> <span class="ss">:title</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@id</span> <span class="o">=</span> <span class="nb">id</span>
</span><span class='line'>    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class='line'>    <span class="vi">@birthdate</span> <span class="o">=</span> <span class="n">birthdate</span>
</span><span class='line'>    <span class="vi">@gender</span> <span class="o">=</span> <span class="n">gender</span>
</span><span class='line'>    <span class="vi">@title</span> <span class="o">=</span> <span class="n">title</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">dave</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Dave&quot;</span><span class="p">,</span><span class="s2">&quot;06-01-1974&quot;</span><span class="p">,</span><span class="s2">&quot;male&quot;</span><span class="p">,</span><span class="s2">&quot;Baron&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">dave</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">dave</span><span class="o">.</span><span class="n">gender</span>
</span></code></pre></td></tr></table></div></figure>


<p>Interesting.  The size of these two bits of code is more or less the same, but the class-based version is full of <em>special forms</em>.  Special Forms are essentially magic provided by the language or runtime.  To understand this code, you need to know:</p>

<ul>
<li>what <code>class</code> means</li>
<li>that calling <code>new</code> on the class&#8217;s name calls the <code>initialize</code> methods</li>
<li>what methods are</li>
<li>that prepending <code>@</code> to a variable makes it private to the class&#8217; instance</li>
<li>the difference between a class and an instance</li>
<li>what <code>attr_reader</code> does</li>
</ul>


<p>Compared to our functional version, all you need to know is:</p>

<ul>
<li>how to define a function</li>
<li>how to invoke a function</li>
</ul>


<p>Like I said, I find this interesting.  We have two ways of writing essentially the same code, and one way requires you to have a lot more special knowledge than the other.</p>

<p>OK, now that we have a real data structure, let&#8217;s rework our code to use it, instead of arrays:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">read_person_from_user</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Name?&quot;</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Birthdate?&quot;</span>
</span><span class='line'>  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Gender?&quot;</span>
</span><span class='line'>  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Title?&quot;</span>
</span><span class='line'>  <span class="n">title</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Name is required&quot;</span><span class="o">]</span>                  <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Birthdate is required&quot;</span><span class="o">]</span>             <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender is required&quot;</span><span class="o">]</span>                <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender must be &#39;male&#39; or &#39;female&#39;&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;male&#39;</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                                                      <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;female&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">id</span> <span class="o">=</span> <span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span>
</span><span class='line'>  <span class="o">[</span><span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">),</span><span class="nb">id</span><span class="p">),</span><span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">handle_result</span><span class="o">.</span><span class="p">(</span><span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="n">read_person_from_user</span><span class="o">.</span><span class="p">()),</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully added person </span><span class="si">#{</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">person</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Problem: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>add_person</code> is a bit noisier, due to the syntax of getting an attribute, but we can now add new fields very easily and keep things structured.</p>

<h2>Object-orientation is just functions</h2>

<p>We can also add derived fields.  Suppose we want a saluation for the person that uses their title?  We can make that an attribute of the person:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">new_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">id</span>        <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:id</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">name</span>      <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:name</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">birthdate</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:birthdate</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">gender</span>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:gender</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">title</span>     <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:title</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:salutation</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">name</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">name</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="kp">nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Heck, we can create full-on OO-style <em>methods</em> if we wanted to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">new_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">id</span>        <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:id</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">name</span>      <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:name</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">birthdate</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:birthdate</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">gender</span>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:gender</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">title</span>     <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:title</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:salutation</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">name</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">name</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:update</span>
</span><span class='line'>      <span class="n">update_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:destroy</span>
</span><span class='line'>      <span class="n">delete_person</span><span class="o">.</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="kp">nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">some_person</span><span class="o">.</span><span class="p">(</span><span class="ss">:update</span><span class="p">)</span>
</span><span class='line'><span class="n">some_person</span><span class="o">.</span><span class="p">(</span><span class="ss">:destroy</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>While we&#8217;re at it, let&#8217;s add inheritance!  Suppose we have an employee that is a person, but with an employee id number:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">new_employee</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">employee_id_number</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">=</span> <span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">employee_id_number</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:employee_id_number</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve created classes, objects, and inheritance, all with just functions, and in just a few lines of code.</p>

<p>In a sense, an object in an OO language is a set of functions that have access to a shared set of data.  It&#8217;s not hard to see why adding an object system to a functional
language is considered trivial by those knoweldgable in functional languages.  It&#8217;s certainly a lot easier than adding functions to an object-oriented language!</p>

<p>Although the syntax for accessing attributes is a bit clunky, I&#8217;m not feeling a <em>ton</em> of pain by not having classes.  Classes seem almost like syntactic sugar at this point,
rather than some radical concept.</p>

<p>One thing that seems problematic is mutation.  Look at how verbose <code>add_person</code> is.  It calls <code>insert_person</code> to put our person into the database, and
gets an ID back.  We then have to create an entirely new person just to set the ID.  In classic OO, we&#8217;d just do <code>person.id = id</code>.</p>

<p>Is mutable state what&#8217;s nice about this construct?  I&#8217;d argue that its compactness is what&#8217;s nice, and the fact that this compactness is implemented via mutable state is just
incidental.  Unless we are in a severely memory-starved environment, with terrible garbage collection, we aren&#8217;t going to be concerned about making new objects.  We <em>are</em> going
to be annoyed by the needless repetition of building new objects from scratch.  Since we already know how to add functions to our, er, function, let&#8217;s add one to bring back
this compact syntax.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">new_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">id</span>        <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:id</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">name</span>      <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:name</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">birthdate</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:birthdate</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">gender</span>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:gender</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">title</span>     <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:title</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:salutation</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">name</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">name</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:with_id</span> <span class="c1"># &lt;===</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, <code>add_person</code> is even simpler:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Name is required&quot;</span><span class="o">]</span>                  <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Birthdate is required&quot;</span><span class="o">]</span>             <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender is required&quot;</span><span class="o">]</span>                <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender must be &#39;male&#39; or &#39;female&#39;&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;male&#39;</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                                                      <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;female&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">id</span> <span class="o">=</span> <span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span>
</span><span class='line'>  <span class="o">[</span><span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="ss">:with_id</span><span class="p">,</span><span class="nb">id</span><span class="p">),</span><span class="kp">nil</span><span class="o">]</span> <span class="c1"># &lt;====</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s not quite as clean as <code>person.id = id</code>, but it&#8217;s terse enough that it&#8217;s still readable, and the code is better for it.</p>

<h2>Namespaces are just functions</h2>

<p>What I&#8217;m really missing is namespaces.  If you&#8217;ve done any C programming, you know that your code becomes littered with functions that have complex prefixes to avoid
name-clashes.  We could certainly do that here, but it would be nice to have proper namespacing, like we get via modules in Ruby or object literals in JavaScript.
We&#8217;d like to add this without adding a feature to our language.  The simplest way to do that is to implement some sort of map.  We can already get explicit attributes
of a data structure, so we just need a more generic way to do so.</p>

<p>Currently, the only data structure we have is an array, and we don&#8217;t have methods, since we don&#8217;t have classes.  The arrays we have are really tuples, and the only general
operations we have are the ability to extract data from them.  For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">first</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">((</span><span class="n">f</span><span class="p">,</span><span class="o">*</span><span class="n">rest</span><span class="p">))</span> <span class="p">{</span> <span class="n">f</span>    <span class="p">}</span> <span class="c1"># or should I name this car? :)</span>
</span><span class='line'><span class="n">rest</span>  <span class="o">=</span> <span class="o">-&gt;</span><span class="p">((</span><span class="n">f</span><span class="p">,</span><span class="o">*</span><span class="n">rest</span><span class="p">))</span> <span class="p">{</span> <span class="n">rest</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can model a map as a list, by treating it as a list with three entires: the key, the value, and the rest of the map.  Let&#8217;s avoid the &#8220;OO style&#8221; of making &#8220;methods&#8221; and
just keep it pureful functional:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">empty_map</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="n">add</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="o">[</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">map</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">get</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">map</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">map</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="k">if</span> <span class="n">map</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">get</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use it like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">map</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">empty_map</span><span class="p">,</span><span class="ss">:foo</span><span class="p">,</span><span class="ss">:bar</span><span class="p">)</span>
</span><span class='line'><span class="n">map</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="ss">:baz</span><span class="p">,</span><span class="ss">:quux</span><span class="p">)</span>
</span><span class='line'><span class="n">get</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="ss">:foo</span><span class="p">)</span>  <span class="c1"># =&gt; :bar</span>
</span><span class='line'><span class="n">get</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="ss">:baz</span><span class="p">)</span>  <span class="c1"># =&gt; :quux</span>
</span><span class='line'><span class="n">get</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="ss">:blah</span><span class="p">)</span> <span class="c1"># =&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is enough to namepsace things:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">empty_map</span> <span class="p">,</span><span class="ss">:insert</span> <span class="p">,</span><span class="n">insert_person</span><span class="p">)</span>
</span><span class='line'><span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">people</span>    <span class="p">,</span><span class="ss">:update</span> <span class="p">,</span><span class="n">update_person</span><span class="p">)</span>
</span><span class='line'><span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">people</span>    <span class="p">,</span><span class="ss">:delete</span> <span class="p">,</span><span class="n">delete_person</span><span class="p">)</span>
</span><span class='line'><span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">people</span>    <span class="p">,</span><span class="ss">:fetch</span>  <span class="p">,</span><span class="n">fetch_person</span><span class="p">)</span>
</span><span class='line'><span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">people</span>    <span class="p">,</span><span class="ss">:new</span>    <span class="p">,</span><span class="n">new_person</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Name is required&quot;</span><span class="o">]</span>                  <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Birthdate is required&quot;</span><span class="o">]</span>             <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender is required&quot;</span><span class="o">]</span>                <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender must be &#39;male&#39; or &#39;female&#39;&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;male&#39;</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                                                      <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;female&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">id</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">people</span><span class="p">,</span><span class="ss">:insert</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span>
</span><span class='line'>                            <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span>
</span><span class='line'>                            <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span>
</span><span class='line'>                            <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">[</span><span class="n">get</span><span class="p">(</span><span class="n">people</span><span class="p">,</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="ss">:with_id</span><span class="p">,</span><span class="nb">id</span><span class="p">),</span><span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We could certainly replace our <code>new_person</code> implementation with a map, but it&#8217;s nice to have an explicit list of attributes that we support, so we&#8217;ll leave <code>new_person</code> as-is.</p>

<p>One last bit of magic.  <code>include</code> is a nice feature of Ruby; it lets us bring modules into scope to avoid using the namespace.  Can we do that here?  We can get close:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_namespace</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">code</span><span class="o">.</span><span class="p">(</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Name is required&quot;</span><span class="o">]</span>                  <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Birthdate is required&quot;</span><span class="o">]</span>             <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender is required&quot;</span><span class="o">]</span>                <span class="k">if</span> <span class="nb">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">&quot;Gender must be &#39;male&#39; or &#39;female&#39;&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;male&#39;</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                                                      <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;female&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">include_namespace</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="ss">:insert</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span>
</span><span class='line'>                     <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span>
</span><span class='line'>                     <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span>
</span><span class='line'>                     <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">[</span><span class="n">_</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="ss">:with_id</span><span class="p">,</span><span class="nb">id</span><span class="p">),</span><span class="kp">nil</span><span class="o">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, this might be over the top, but it&#8217;s fairly interesting to think of something like <code>include</code> as just a way to &#8220;type less stuff&#8221;, and that we can achieve a similar
reduction in &#8220;typing stuff&#8221; by just using functions.</p>

<h2>What have we learned?</h2>

<p>With just a few basic language constructs, we can create a fairly usable programming language.  We can create bona-fide types, namespaces, and even
do object-oriented programming, without any explicit support for these features.  And we can do so in more or less the same amount of code that would be required
by using Ruby&#8217;s built-in support.  The syntax is <em>slightly</em> verbose compared to the full-blown Ruby equivalent, but it&#8217;s not
<em>that</em> bad.  We could write real code using this degenerate form of Ruby, and it wouldn&#8217;t be too bad.</p>

<p>Does this help us in our everyday work?  I think this is a lesson in simplicity.  Ruby is fraught with DSLs, abused syntax, and meta-programming, yet we&#8217;ve just
been able to accomplish a lot without even using classes!  Perhaps the problem you have in front of you can be solved by something simple?  Perhaps you don&#8217;t
need anything fancy, but can rely on the more straightforward parts of your language.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[&#10106;&#10144; What is 'better' code?]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/06/27/what-is-better-code.html"/>
    <updated>2012-06-27T14:48:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/06/27/what-is-better-code</id>
    <content type="html"><![CDATA[<p>We all want better code.  Rails creator David Heinemeier Hansson said that the only way to evaluate a code change is if the new code is &#8220;better&#8221; than the old.  Of course, he didn&#8217;t define what he meant by &#8220;better&#8221;.  At Scottish Ruby Conf, Dave Thomas said that good code is code that is easy to change.  This is a bit more specific, but not really enough to give any real direction.</p>

<p>Let&#8217;s see if we can derive a real understanding of code quality.</p>

<!-- more -->


<p>What do we do with code?  In decreasing order of frequency:</p>

<ul>
<li><em>We execute it.</em>  Hopefully, our code spends most of its time executing.</li>
<li><em>We read it.</em>  To gain an understanding, to review it, to change it, we must read it.</li>
<li><em>We change it.</em>  To add new features, or fix bugs, we must change it.</li>
<li><em>We write it.</em>  On occasion, we&#8217;ll write new code.</li>
</ul>


<p>The most frequent thing we do with code?  Execute it.  Code that runs, based on our current understanding (i.e. passes its tests), is the absolute minimum of acceptability.  It&#8217;s at this point that average developers typically stop.  If it works, ship it!</p>

<p>We aren&#8217;t average developers.  We want to do better.</p>

<p>With almost equally great frequency, our code gets read by humans.  We might read code to prepare for a change.  We might read code to understand how a business rule works.  We might read code as an example of how to do something, or to gain an understanding of some abstract concept.  We read code a lot.</p>

<p>Is there anything objective we can say about code readability?</p>

<h2>Readability</h2>

<p>Readability answers the question &#8220;How quickly can someone understand this code?&#8221;  We must first define &#8220;someone&#8221;.  A good rule of thumb is &#8220;any developer that could be hired to work here&#8221;.  You may need to get more specific, but generally constraining the context to your current team will work well.</p>

<p>Once we&#8217;ve got context for understanding code, the most obvious thing we could measure would be its size.</p>

<h3>Size</h3>

<p>Size can mean two things: length (the number of lines of code) and <em>density</em> (the amount of information per line of code).  The more code you must evaluate, by either measure, the longer it will take to come to an understanding.  The distinction between length and density is interesting.  Short, but dense code, can be just as difficult to grasp as long sparse code.</p>

<figure class='code'><figcaption><span>Dense, but short code</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_new_person</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">birthdate</span><span class="p">)</span>
</span><span class='line'>  <span class="k">raise</span> <span class="s2">&quot;first name and last name required&quot;</span> <span class="k">if</span> <span class="n">first_name</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">last_name</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>  <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="n">first_name</span><span class="p">,</span> <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="n">last_name</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="p">{</span> <span class="o">|</span><span class="n">person</span><span class="o">|</span>
</span><span class='line'>    <span class="n">person</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">birthdate</span><span class="o">.</span><span class="n">year</span> <span class="k">if</span> <span class="n">birthdate</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s the same routine, rewritten to be as sparse as possible:</p>

<figure class='code'><figcaption><span>Longer, sparser code</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_new_person</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">birthdate</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">first_name</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">last_name</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;first name and last name required&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="n">first_name</span><span class="p">,</span> <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="n">last_name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">birthdate</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>    <span class="n">person</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">birthdate</span><span class="o">.</span><span class="n">year</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">person</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which one do you find easier to understand?  I would argue that the answer is not so clear-cut.  What <em>is</em> interesting is that modern languages, like Ruby or Scala, tend to encourage denser, shorter programs.  Some densly-packed statements are idiomatic, and are easily understood, while others become impeneatrable code golf.  Know the difference and you can get a good sense of the size of a piece of code.</p>

<h3>Variables</h3>

<p>Any field, parameter, global, or local variable is a &#8220;variable&#8221; for the purposes of code readability.  Variables are placeholders for the calculations our code performs, and the more of them there are, the more abstract pieces of data you must hold in your head in
order to understand a piece of code.</p>

<p>Beyond the raw count of variables, the scope of each variable can also affect our understanding of code.  A routine that uses nothing but local variables will be easier to undestand than one using all globals.  Since globals can change outside of the routine you are reading, you need to have a higher level grasp of the system, so you can understand what possible values those variables might have.  The smaller the scope of a variable, the easier it is to understand what values it might have, and the easier it is to understand the code it&#8217;s used in.</p>

<p>Of course, variable names are important, too.  Descriptive (and accurate) names help our understanding, while symbol or inaccurate names can harm it.</p>

<p>Here&#8217;s a pattern I&#8217;ve seen in complex controllers, where ivars are used to pass variables between methods (you&#8217;ll need to imagine many other controller methods here):</p>

<figure class='code'><figcaption><span>A Controller with too many variables that have a large scope</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PeopleController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">can_destroy?</span>
</span><span class='line'>      <span class="vi">@person</span><span class="o">.</span><span class="n">destroy</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">persons_path</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@error</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">persons_path</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">can_destroy?</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@person</span><span class="o">.</span><span class="n">admin?</span>
</span><span class='line'>      <span class="vi">@error</span> <span class="o">=</span> <span class="s1">&#39;You cannot delete an admin&#39;</span>
</span><span class='line'>      <span class="kp">false</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="vi">@person</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">unfulfilled</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>      <span class="vi">@error</span> <span class="o">=</span> <span class="s1">&#39;Person has unfullied orders&#39;</span>
</span><span class='line'>      <span class="kp">false</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how both outcomes of <code>destroy</code> are redirects, yet we are setting <code>@person</code>.  In a Rails controller, you create ivars to communicate data to the view, but for a redirect, these variables don&#8217;t apply.  <code>@person</code> is effectively a parameter passed to <code>can_destroy?</code> but without declaring it as a parameter.  Further, <code>@error</code> is being initialized in <code>can_destroy?</code> and acts as a return value.  Finally, does <code>id</code> need to be a variable at all?  It&#8217;s only used in one place.  Here&#8217;s a version that keeps variables to a minimum scope:</p>

<figure class='code'><figcaption><span>A Controller with fewer variables of smaller scope</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PeopleController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">error</span> <span class="o">=</span> <span class="n">can_destroy?</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>      <span class="n">person</span><span class="o">.</span><span class="n">destroy</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">persons_path</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="n">error</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">persons_path</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">can_destroy?</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">admin?</span>
</span><span class='line'>      <span class="s1">&#39;You cannot delete an admin&#39;</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">person</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">unfulfilled</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>      <span class="s1">&#39;Person has unfullied orders&#39;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not only is the code a bit shorter, but each routine is simpler to understand, because the scope of the variables used are constrainted to only where they are needed.</p>

<h3>Number of classes/methods</h3>

<p>This is where things get interesting.  If you need to follow the path of execution through many methods or classes to get an understanding of some code, it&#8217;s going to be harder to do so.  Of course, with fewer classes, you&#8217;ll tend toward larger methods which, of course, can also be hard to understand.</p>

<p>Consider the refactor from my <a href="http://www.naildrivin5.com/blog/2012/06/10/single-responsibility-principle-and-rails.html">controversial blog post</a>.  In that post, I extracted a class from a Rails controller to handle the business process of creating a new user.  Although the two classes were both very short and easy to understand, the entire codebase went from one class that contained all the code, to two classes.  Which is easier to understand?  It depends.  But, by trying to quantify the differences in the code, we can approach an understanding.</p>

<h3>Paths through the code</h3>

<p>Often referred to as &#8220;complexity&#8221; in computer science, the number of possble paths of execution through a piece of code can greatly affect its ability to be understood by a person.  Consider this slightly modified version of <code>can_destroy?</code> from our example above:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">can_destroy?</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>  <span class="n">errors</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">admin?</span>
</span><span class='line'>    <span class="n">errors</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;You cannot delete an admin&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">unfulfilled</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="n">errors</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;Person has unfullied orders&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are two <code>if</code> statements here, which gives us <em>four</em> possible ways through this code.  This means that, to gain a real understanding of this code, we need to mentally play through all four scenarios in our heads.  Since the expression of each <code>if</code> statement is simple, this isn&#8217;t so bad.  What if we needed to add a feature where employees are also not allowed to be destroyed in our controller?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">can_destroy?</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>  <span class="n">errors</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">admin?</span> <span class="o">||</span> <span class="n">person</span><span class="o">.</span><span class="n">is_employee?</span>
</span><span class='line'>    <span class="n">errors</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;You cannot delete an admin or employee&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">unfulfilled</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="n">errors</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;Person has unfullied orders&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve added an additional case for our first <code>if</code> statement, and so we have more paths:</p>

<ul>
<li><code>person.admin?</code> true, <code>#is_employee?</code> false, <code>orders.unfulfilled.any?</code> false</li>
<li><code>person.admin?</code> true, <code>#is_employee?</code> true, <code>orders.unfulfilled.any?</code> false</li>
<li><code>person.admin?</code> true, <code>#is_employee?</code> false, <code>orders.unfulfilled.any?</code> true</li>
<li><code>person.admin?</code> true, <code>#is_employee?</code> true, <code>orders.unfulfilled.any?</code> true</li>
<li><code>person.admin?</code> false, <code>#is_employee?</code> false, <code>orders.unfulfilled.any?</code> false</li>
<li><code>person.admin?</code> false, <code>#is_employee?</code> true, <code>orders.unfulfilled.any?</code> false</li>
<li><code>person.admin?</code> false, <code>#is_employee?</code> false, <code>orders.unfulfilled.any?</code> true</li>
<li><code>person.admin?</code> false, <code>#is_employee?</code> true, <code>orders.unfulfilled.any?</code> true</li>
</ul>


<p>If we were to extract the first <code>if</code> statement&#8217;s expression to a method, we&#8217;d reduce the complexity of this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">deletable?</span>
</span><span class='line'>    <span class="n">person</span><span class="o">.</span><span class="n">admin?</span> <span class="o">||</span> <span class="n">person</span><span class="o">.</span><span class="n">is_employee?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">can_destroy?</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</span><span class='line'>  <span class="n">errors</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">deletable?</span>
</span><span class='line'>    <span class="n">errors</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;You cannot delete an admin or employee&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">unfulfilled</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="n">errors</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;Person has unfullied orders&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve simplified <code>can_destroy?</code>, but we&#8217;ve added a new method to <code>Person</code>.  Readability isn&#8217;t so simple, is it?</p>

<p>Let&#8217;s complicate things further by understanding our abilitiy to change code.</p>

<h2>Ability to Change</h2>

<p>When changing code, you often want to know where to make the change, but you also want to keep the scope of the change as small as possible.  Readability in general, and the measures we&#8217;ve outlined above in particular, affect this greatly.  If we have one giant routine, we know where to make the change, but if we have many single-purpose classes instead, the scope of our change is smaller.  Are there other aspects of our code that affect this?</p>

<p>In general, <em>coupling</em> is an indicator of the scope of a particular change.  If two classes are tightly coupled, it means that a change one is likely to necessitate a change in another.  Further, a class that is coupled to many classes is going to result in a system that is harder to change.  This is the basis for the &#8220;Law of Demeter&#8221;.  Code that &#8220;violates&#8221; this law is coupling itself to more classes than code that doesn&#8217;t &#8220;violate&#8221; the &#8220;law&#8221; and is thus harder to change.</p>

<p>The dependencies between classes are a good indicator of coupling.</p>

<h3>Fan out</h3>

<p>A class or method that uses a lot of classes or methods to do its work has higher coupling than one that uses fewer.  This is often referred to as <em>fan out</em>, and it means that the class in question is more likely to have to change when the classes or methods it uses change.</p>

<h3>Fan in</h3>

<p>Conversely, a class or method that a lot of other classes or methods use also has high coupling.  Obvious examples in a Rails app would be a central model object (like a person or an order), or helper methods in <code>ApplicationHelper</code>.  These objects and methods get used everywhere, and thus are very hard to change, because a change can have a ripple effect through the system.</p>

<p>Notice again how these conflict with other attributes of readability.  A routine that is quite large, but has no external dependencies has almost no coupling, but could be hard to understand, since it is long, potentially having many variables and many paths through the code. Code spread across many single-purpose classes in a loosely coupled way will be easier to change, but potentially harder to understand.</p>

<h2>Better</h2>

<p>So, what is &#8220;better&#8221; code?  I don&#8217;t think we&#8217;ll ever have a fool-proof way of figuring this out, but we <em>do</em> have objective measures we can use to better explain why we think one piece of code might be better than another.    Next time you&#8217;re reviewing code or doing a refactor, instead of relying on a gut feel of &#8220;better&#8221;, jot down where the code stands along measurements like these. How does the new code compare to the old?  The answer might surprise you.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tap versus intermediate variables]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/06/22/tap-versus-intermediate-variables.html"/>
    <updated>2012-06-22T12:55:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/06/22/tap-versus-intermediate-variables</id>
    <content type="html"><![CDATA[<p>In my <a href="http://davetron5000.github.com/ruby-style">Ruby style guide</a>, I mention the preference for using Ruby&#8217;s <code>tap</code>:</p>

<blockquote><p>When you must mutate an object before returning it, avoid creating intermediate objects and use tap:</p></blockquote>

<p>I thought it might be interesting to expand on this.</p>

<!-- more -->


<h2>What is <code>tap</code>?</h2>

<p>First off, <code>tap</code> is a method on <code>Object</code> that takes a block, which is passed itself, and evaluates to itself.  Whoa.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Object</span>
</span><span class='line'>  <span class="c1"># Imagined implementation</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>An interesting use of <code>tap</code> is when debugging a <a href="http://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a> violation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># before</span>
</span><span class='line'><span class="vi">@person</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">nag</span><span class="p">(</span><span class="ss">:are_we_there_yet?</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># after</span>
</span><span class='line'><span class="vi">@person</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">parents</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">parents</span><span class="o">.</span><span class="n">inspect</span> <span class="p">}</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">nag</span><span class="p">(</span><span class="ss">:are_we_there_yet?</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>No matter what happens inside of the block you give to <code>tap</code>, the call always evaluates to the object itself.  We don&#8217;t change the string of calls, but can inject code into it.</p>

<p>This is not the power of <code>tap</code> in my opinion.  I use <code>tap</code> when:</p>

<ul>
<li>I&#8217;m writing a method that creates and returns an object</li>
<li>I must modify or call methods on that object before returning it</li>
</ul>


<h2>Intermediate Variable Elimination Front</h2>

<p>From <a href="http://www.naildrivin5.com/blog/2012/06/10/single-responsibility-principle-and-rails.html">my last blog post</a>, I had this method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_user</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">new_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>      <span class="no">UserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Between creating the user and returning it, I needed to do some other stuff, so I create a scope in which to do it with <code>tap</code>.</p>

<p>The classic approach is to use an intermediate variable for the new user and looks like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">new_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">new_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>    <span class="no">UserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">new_user</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Same lines of code, so why is the <code>tap</code> version better?</p>

<p>From my style guide<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>:</p>

<blockquote><p>Intermediate objects increase the mental requirements for understanding a routine. <code>tap</code> also creates a nice scope in which the object is being mutated; you will not forget to return the object when you change the code later</p></blockquote>

<p>Let&#8217;s look at our intermediate routine again, this time, marking a few places in the code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">new_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">new_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>    <span class="no">UserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># 1</span>
</span><span class='line'>  <span class="n">new_user</span>
</span><span class='line'>  <span class="c1"># 2</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Here is where any new code should be added to this method.</li>
<li>Here is where you might add new code that will cause this method to break</li>
</ol>


<p>A developer&#8217;s instinct is to add new code &#8220;at the bottom&#8221;.  In the &#8220;intermediate variables&#8221; version, the last line is special, so
you have to add code on the <em>second to last line</em>.</p>

<p>But, isn&#8217;t that the same in the <code>tap</code> version?  No, because <code>tap</code> creates a scope, visually and literally.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_user</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">new_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>      <span class="no">UserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="c1"># 1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The location of #1 is logically &#8220;the bottom&#8221;, because it&#8217;s the end of the scope in question, and thus where you are more
likely to put new code.  It <em>also</em> alleviates you from having to worry about making sure that <code>new_user</code> is the last thing
evaluated; <code>tap</code> handles that.  No matter what new code you add, the new user is always returned.</p>

<p>I find this simple little thing makes certain routines easier to understand and modify.</p>

<h2>Appendix: What if I don&#8217;t write Ruby code?</h2>

<p>In Scala, this can be achieved using implicits:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">Tapper</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">anyToTapper</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">obj</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Tapper</span><span class="o">(</span><span class="n">obj</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Tapper</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">obj</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">tap</span><span class="o">(</span><span class="n">code</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">code</span><span class="o">(</span><span class="n">obj</span><span class="o">)</span>
</span><span class='line'>    <span class="n">obj</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">Tapper._</span>
</span><span class='line'>
</span><span class='line'><span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">params</span><span class="o">).</span><span class="n">tap</span> <span class="o">{</span> <span class="n">newUser</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">newUser</span><span class="o">.</span><span class="n">isValid</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">UserMailer</span><span class="o">.</span><span class="n">deliverWelcomeEmail</span><span class="o">(</span><span class="n">newUser</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In JavaScript, you can just put it on <code>Object</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">{</span> <span class="nx">block</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">createNewUser</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nx">tap</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newUser</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">newUser</span><span class="p">.</span><span class="nx">isValid</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">new</span> <span class="nx">UserMailer</span><span class="p">().</span><span class="nx">deliverWelcomeEmail</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Java, you&#8217;re screwed, but just for fun, let&#8217;s try:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TapFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">T</span> <span class="n">object</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tapper</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">tap</span><span class="o">(</span><span class="n">T</span> <span class="n">object</span><span class="o">,</span> <span class="n">TapFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">function</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">function</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">static</span> <span class="n">Tapper</span><span class="o">.</span><span class="na">tap</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">createNewUser</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,?&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">tap</span><span class="o">(</span><span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">params</span><span class="o">),</span><span class="k">new</span> <span class="n">TapFunction</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">User</span> <span class="n">newUser</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">newUser</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">UserMailer</span><span class="o">.</span><span class="na">deliverWelcomeEmail</span><span class="o">(</span><span class="n">newUser</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">});</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not exactly a huge win in Java :)  Now, who&#8217;ll write this in C?</p>

<hr />

<div class="footnotes">
    <ol>
        <li id='fn:1'>It&#8217;s a great exercise to create a style guide and then explain <em>why</em> you follow a particular rule.  You might be surprised at the number of “I just like how it looks” reasons. <a href='#fnref:1' rev='footnote'>↩</a></li>
    </ol>
</div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Single Responsibility Principle and Rails]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/06/10/single-responsibility-principle-and-rails.html"/>
    <updated>2012-06-10T14:24:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/06/10/single-responsibility-principle-and-rails</id>
    <content type="html"><![CDATA[<p>Was reading <a href="https://speakerdeck.com/u/tenderlove/p/rails-four">the slides</a> from Aaron Patterson&#8217;s Magma Rails talk and noticed some pretty innocuous Rails code that, upon further reflection is the beginning of disaster for a growing application.  As many other Rubyists are beginning to realize, spreading your application logic across only models and controllers leads to a mess.  Let&#8217;s look at the code, understand why it&#8217;s bad, and create a better version.</p>

<!-- more -->


<p>Here&#8217;s the code to create a new user and email them a welcome note:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>        <span class="no">UserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simple enough, so what&#8217;s the problem?  Let&#8217;s list out the things this class does:</p>

<ul>
<li>creates a new <code>User</code> instance from form parameters</li>
<li>saves the new <code>User</code> to the database</li>
<li>Sends the user an email if the save was successful</li>
<li>Renders the view</li>
</ul>


<p>This is too many things.  Every time we need to add something else that happens when a user is created, we will have to modify this methods.  Further, any other part of the system that creates new users will have to duplicate this code (it&#8217;s not hard to imagine some sort of user import feature to create new users from some other system).</p>

<h2>Fat Models, Skinny Controllers</h2>

<p>The Rails Way&#0153; is to put all of this into the model.  Using the power of Rails, we could do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">after_create</span> <span class="ss">:deliver_welcome_email</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">deliver_welcome_email</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>      <span class="no">UserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Is this better?  Well, our controller is a lot simpler, and now just creates the user and renders the view.  That&#8217;s pretty much all it should be doing.  We&#8217;ve deferred our email to an <code>after_create</code> hook.</p>

<p>All we&#8217;ve done is move the problem somewhere else.  We&#8217;ve also made testing our application a huge pain, because everywhere we create a <code>User</code> instance for a test, we&#8217;ll fire off the <code>UserMailer</code>, so we&#8217;d need to stub that our otherwise arrange for that code not to run, <em>except</em> when we test that code.  Ugh.</p>

<p>So, in solving one problem, we&#8217;ve created another, giving us two problems, now:</p>

<ul>
<li>The <code>User</code> class is doing too much (even if we count all of ActiveRecord as just &#8220;one thing&#8221;)</li>
<li>We&#8217;ve mixed up the concerns of creating instances of <code>User</code> objects with creating new users of our application.  The distinction might be subtle, but it&#8217;s important.</li>
</ul>


<p>We can solve both of these problems using the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility principle</a> and by using one of Ruby&#8217;s most powerful and, sadly, underused features: creating a new class.</p>

<h2>Use Classes</h2>

<p>What we want is a single location for &#8220;someone new is using our application&#8221; and we <em>don&#8217;t</em> want that conflated with the creation of the class we use to store that user&#8217;s data in the database.</p>

<p>Since our new class is going to create new application users, let&#8217;s call it <code>ApplicationUserCreator</code>.  I know it&#8217;s the <a href="http://steve-yegge.blogspot.com/2006/03/execution-in-kingdom-of-nouns.html">Kingdom of Nouns</a>, but the more classes you have, the more specific their names have to be.  We could <a href="http://www.naildrivin5.com/blog/2012/01/30/avoid-kingdom-of-nouns-with-procs.html">use lambdas</a>, but let&#8217;s keep things simple for now.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationUserCreator</span>
</span><span class='line'>  <span class="c1"># Creates a new user for the application, based on form parameters.</span>
</span><span class='line'>  <span class="c1"># Returns the User instance that was created, which might be invalid</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_user</span><span class="o">|</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">new_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>        <span class="no">UserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">ApplicationUserCreator</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Much better.  Our <code>User</code> class remains as it was originally - a class that holds data for the <code>USERS</code> table and provides CRUD operations for it.  Our controller is just as skinny in our second example - it launches the new user creation logic and renders the view.  We have a new class which is custom built to hold the new application user logic.</p>

<p>These three classes are now very easy to test and very easy to understand; they all simply don&#8217;t do that much.  Also, the test for our business logic (the test for <code>ApplicationUserCreator</code>) is <em>blazingly fast</em>.</p>

<h2>Resilience in the Face of Change</h2>

<p>Where a design like this really shines is when we need to add new features to our app.</p>

<p>Suppose we want to do something different when creating administrative users.  These users are still stored in the <code>USERS</code> table, but we want to send them a different welcome email (perhaps admin users get a more security-conscious email).</p>

<p>We could start peppering <code>UserMailer</code> with <code>if user.admin?</code> but that&#8217;s just wrong, too.  The <code>UserMailer</code> already does enough - it emails new application users a welcome email.  It does <em>not</em> need to also email administrative users a security-related email.  Let&#8217;s assume we&#8217;ve created <code>AdminUserMailer</code> to handle that.  We can also assume we have an <code>AdminUsersController</code> that looks
like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AdminUsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">ApplicationUserCreator</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Identical to <code>UsersController</code>, for now.  Our <code>ApplicationUserCreator</code> now needs to check if the new user is an admin.  The quick and dirty path, which will get us into trouble, is to check inside that class, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationUserCreator</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_user</span><span class="o">|</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">new_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">new_user</span><span class="o">.</span><span class="n">admin?</span>
</span><span class='line'>          <span class="no">AdminUserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="no">UserMailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, this sucks.  We now need to double our tests to handle the case where the new user is an admin.  What happens when we add the next few feature?  More <code>if</code> statements and more complication.  Lets decouple this class from the mailer it uses by allowing the mailer to be injectible:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationUserCreator</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">welcome_mailer</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@welcome_mailer</span> <span class="o">=</span> <span class="n">welcome_mailer</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_user</span><span class="o">|</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">new_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">welcome_mailer</span><span class="o">.</span><span class="n">deliver_welcome_email</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">welcome_mailer</span>
</span><span class='line'>    <span class="vi">@welcome_mailer</span> <span class="o">||=</span> <span class="no">UserMailer</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this design, we can change mailers all we want, and won&#8217;t ever need to change <code>ApplicationUserCreator</code> or its tests.  We
should add a test that <code>UserMailer</code> is the default and that we can inject our own mailer, but at that point,
<code>ApplicationUserCreator</code> is a completed class.</p>

<p><code>AdminUsersController</code> now looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AdminUsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">ApplicationUserCreator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">AdminUserMailer</span><span class="p">)</span><span class="o">.</span><span class="n">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not too bad.  The classes involved in user creation are all dead simple and easy to test.</p>

<p>Suppose we had a third type of user creation scenario where we <em>don&#8217;t</em> want welcome emails to be sent at all?  Not a problem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">NoOpMailer</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">deliver_welcome_email</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">ApplicationUserCreator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">NoOpMailer</span><span class="p">)</span><span class="o">.</span><span class="n">create_new_user</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I realize that Aaron&#8217;s code is just an example for a slide at a conference, but I can tell you from experience, that any time an authoritative source shows code to others, they take that as the &#8220;right way&#8221; to do things.  It took the Java community <em>years</em> to stop writing code like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">someCode</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span>
</span><span class='line'>  <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code snippet is in <em>every book</em> on Java I&#8217;ve ever read, and I get why authors write it, but it&#8217;s Just Wrong. So is putting excessive business logic in your controllers or models.</p>

<h2>What you can do</h2>

<p>It&#8217;s very simple.  When you are adding code to your Rails app, ask yourself two questions:</p>

<ul>
<li>Is this code about getting data in the right configuration for the view?  If not, it does not belong in a controller.</li>
<li>Is this code about manipulating data in the database?  If not, it does not belong in the model.</li>
</ul>


<p>Very little of the code you write goes in a controller or model, based on the above criteria.  The code goes in some other class, possibly one you will have to create.  It doesn&#8217;t go in a module that you include into your controller or model.  It doesn&#8217;t go into a module that you <code>extend</code> your model with at runtime, it goes into a class.  That is the unit of code organization in an object-oriented language, so don&#8217;t be afraid to use it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lookup tables with lambdas]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/05/16/lookup-tables-with-lambdas.html"/>
    <updated>2012-05-16T10:34:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/05/16/lookup-tables-with-lambdas</id>
    <content type="html"><![CDATA[<p>Yesterday, I tweeted:</p>

<blockquote class="twitter-tweet"><p>x = Hash.new { |_,_|lambda {}}.tap { |hash|hash[:key] = lambda {}}x[attr].callFilthy?I kinda like it</p>&mdash; ❺➠ David Copeland (@davetron5000) <a href="https://twitter.com/davetron5000/status/202520727239409664" data-datetime="2012-05-15T22:07:58+00:00">May 15, 2012</a></blockquote>


<script src="http://www.naildrivin5.com//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>This may seem crazy, but it&#8217;s a really just an enhanced use of what Steve McConnell, in &#8220;Code Complete&#8221;, describes as
<em>Table-Driven Methods</em>.  Let&#8217;s see what that has to do with my crazy <code>Hash</code> construct.</p>

<!-- more -->


<p>If you haven&#8217;t read <a href="http://www.amazon.com/Code-Complete-Practical-Handbook-Construction/dp/0735619670">&#8220;Code Complete&#8221;</a>, and you are a relatively inexperienced developer, I highly recommend it.  My
version has a lot of Pascal in it, and I think the latest might use Visual Basic (!), but it doesn&#8217;t matter.  There&#8217;s a lot of
useful gems in there.</p>

<p>One of them is &#8220;Table-Driven Methods&#8221;, which he describes as</p>

<blockquote><p>a scheme that allows you to look up information in a table rather than using logic statements to figure it out</p></blockquote>

<p>In the simplest form, you&#8217;d replace a <code>case</code> statement with a table lookup.  Consider this method that determines, based on the
type of credit card, what countries that card can be used in:</p>

<figure class='code'><figcaption><span>Complex case statement</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">countries_usable_in</span>
</span><span class='line'>  <span class="k">case</span> <span class="nb">self</span><span class="o">.</span><span class="n">card_type</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;discover&#39;</span>
</span><span class='line'>      <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;maestro&#39;</span>
</span><span class='line'>      <span class="o">[</span><span class="s1">&#39;UK&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;visa&#39;</span>
</span><span class='line'>      <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="p">,</span><span class="s1">&#39;UK&#39;</span><span class="p">,</span><span class="s1">&#39;IE&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="k">when</span> <span class="s1">&#39;master_card&#39;</span>
</span><span class='line'>      <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="p">,</span><span class="s1">&#39;UK&#39;</span><span class="p">,</span><span class="s1">&#39;IE&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This could be easily replaced by:</p>

<figure class='code'><figcaption><span>Table-driven method</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CARD_TYPE_COUNTRIES</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s1">&#39;discover&#39;</span>    <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;maestro&#39;</span>     <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;UK&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;visa&#39;</span>        <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="p">,</span><span class="s1">&#39;UK&#39;</span><span class="p">,</span><span class="s1">&#39;ZA&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;master_card&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="p">,</span><span class="s1">&#39;UK&#39;</span><span class="p">,</span><span class="s1">&#39;ZA&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">countries_usable_in</span>
</span><span class='line'>  <span class="no">CARD_TYPE_COUNTRIES</span><span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">card_type</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is much less complex, both from a formal perspective, and from a general &#8220;what&#8217;s going on here?&#8221; perspective.  We replace a
bunch of conditionals with a simple mapping.  Enhancing this code is simple: we just add a new entry to the <code>CARD_TYPE_COUNTRIES</code>
<code>Hash</code> and we&#8217;re on our way.</p>

<p>This has a couple of problems with it.  You&#8217;ll notice that both &#8220;visa&#8221; and &#8220;master_card&#8221; map to the same list.  What we really
want is to treat &#8220;discover&#8221; and &#8220;maestro&#8221; as special, and then for any other card type, return our default list of US, UK, and
South Africa.</p>

<p>Ruby&#8217;s <code>Hash</code> constructor can be given a block that returns the value to use when a key is missing, so that would seem to be
useful:</p>

<figure class='code'><figcaption><span>Hash special constructor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span><span class="n">value</span>
</span><span class='line'>  <span class="s2">&quot;FOO&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">hash</span><span class="o">[</span><span class="ss">:blah</span><span class="o">]</span> <span class="c1"># =&gt; &quot;FOO&quot;</span>
</span><span class='line'><span class="nb">hash</span><span class="o">[</span><span class="ss">:blah</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;BAR&quot;</span>
</span><span class='line'><span class="nb">hash</span><span class="o">[</span><span class="ss">:blah</span><span class="o">]</span> <span class="c1"># =&gt; &quot;BAR&quot;</span>
</span><span class='line'><span class="nb">hash</span><span class="o">[</span><span class="ss">:crud</span><span class="o">]</span> <span class="c1"># =&gt; &quot;FOO&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, this makes it a bit awkward to populate our <code>Hash</code> with the lookup table, because we lose the literal syntax.  We can
deal with <em>this</em> by using <code>tap</code>, which passes the object called on it to the block passed to it, executes the block, throws away
the block&#8217;s return value and returns the object on which we called <code>tap</code>.  Whoa.  Let&#8217;s look at an example.</p>

<figure class='code'><figcaption><span>Using Hash special constructor and pre-populating it with values</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">CARD_TYPE_COUNTRIES</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>  <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="p">,</span><span class="s1">&#39;UK&#39;</span><span class="p">,</span><span class="s1">&#39;IE&#39;</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_hash</span><span class="o">|</span>
</span><span class='line'>  <span class="n">new_hash</span><span class="o">[</span><span class="s1">&#39;discover&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">new_hash</span><span class="o">[</span><span class="s1">&#39;maestro&#39;</span><span class="o">]</span>  <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;UK&#39;</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, when we call <code>CARD_TYPE_COUNTRIES['visa']</code>, this uses the block we gave to the constructor, but
<code>CARD_TYPE_COUNTRIES['maestro']</code> simply returns the literal array we assigned in <code>tap</code>.</p>

<p>So far so good.  Now, suppose we have a new requirement to add American Express.  Suppose that American Express isn&#8217;t supported in African countries, but works everywhere else.  Since we don&#8217;t want to hard-code what countries are in Africa, we&#8217;ll need to consult the database.</p>

<figure class='code'><figcaption><span>Yucky implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">countries_usable_in</span>
</span><span class='line'>  <span class="n">countries</span> <span class="o">=</span> <span class="no">CARD_TYPE_COUNTRIES</span><span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">card_type</span><span class="o">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">card_type</span> <span class="o">==</span> <span class="s1">&#39;american_express&#39;</span>
</span><span class='line'>    <span class="n">countries</span> <span class="o">-</span> <span class="no">Continent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Africa&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">countries</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">countries</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve re-introduced those pesky control structures we were trying to remove.  Why can&#8217;t we do this?</p>

<figure class='code'><figcaption><span>Putting database calls into our constant initialization</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">DEFAULT_COUNTRIES</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="p">,</span><span class="s1">&#39;UK&#39;</span><span class="p">,</span><span class="s1">&#39;IE&#39;</span><span class="o">]</span>
</span><span class='line'><span class="no">CARD_TYPE_COUNTRIES</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>  <span class="no">DEFAULT_COUNTRIES</span>
</span><span class='line'><span class="p">}</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_hash</span><span class="o">|</span>
</span><span class='line'>  <span class="n">new_hash</span><span class="o">[</span><span class="s1">&#39;discover&#39;</span><span class="o">]</span>         <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">new_hash</span><span class="o">[</span><span class="s1">&#39;maestro&#39;</span><span class="o">]</span>          <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;UK&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">new_hash</span><span class="o">[</span><span class="s1">&#39;american_express&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">DEFAULT_COUNTRIES</span> <span class="o">-</span> <span class="no">Continent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Africa&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">countries</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This has two problems:</p>

<ul>
<li>The database query is only run on app startup, so any changes won&#8217;t affect things until we restart (imagine our <code>COUNTRIES</code> table only having countries we support and not <em>all</em> countries; we want to add new countries without an app restart)</li>
<li>We are running a database query inside a class definition and we don&#8217;t necessarily have a guarantee that the database connection is even established at that point.</li>
</ul>


<p>What we need is a lookup table that calculates its results on demand.  Ruby has a structure for that: <code>lambda</code></p>

<figure class='code'><figcaption><span>Lookup table that calculates results on demand</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">DEFAULT_COUNTRIES</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="p">,</span><span class="s1">&#39;UK&#39;</span><span class="p">,</span><span class="s1">&#39;IE&#39;</span><span class="o">]</span>
</span><span class='line'><span class="no">CARD_TYPE_COUNTRIES</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>  <span class="no">DEFAULT_COUNTRIES</span>
</span><span class='line'><span class="p">}</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">new_hash</span><span class="o">|</span>
</span><span class='line'>  <span class="n">new_hash</span><span class="o">[</span><span class="s1">&#39;discover&#39;</span><span class="o">]</span>         <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">[</span><span class="s1">&#39;US&#39;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">new_hash</span><span class="o">[</span><span class="s1">&#39;maestro&#39;</span><span class="o">]</span>          <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">[</span><span class="s1">&#39;UK&#39;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">new_hash</span><span class="o">[</span><span class="s1">&#39;american_express&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span>
</span><span class='line'>    <span class="no">DEFAULT_COUNTRIES</span> <span class="o">-</span> <span class="no">Continent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Africa&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">countries</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">countries_usable_in</span>
</span><span class='line'>  <span class="no">CARD_TYPE_COUNTRIES</span><span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">card_type</span><span class="o">].</span><span class="n">call</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I find this to be a pretty clean solution.  We have all the benefits of a table-driven approach, but only need to specify special
cases (thanks to our default block), and have the ability to calcualte our results on demand, based on the current state of the system (thanks to using lambdas and static values).  Not too bad.</p>

<p>Let&#8217;s take this concept even further.  We often write code using an <code>if..elsif..else..end</code> structure that essentially tries
various conditions to find one that holds, and returns a value based on that condition.</p>

<p>As an example, we&#8217;ll switch domains to my favorite: <a href="http://www.pragprog.com/titles/dccar">command line apps</a>.  Suppose I need to determine the size of the user&#8217;s terminal so I can properly format output.  My algorithm will be:</p>

<ul>
<li>If the environment variable <code>COLUMNS</code> is a number, use that</li>
<li>Otherwise, if the command <code>tput</code> exists, run <code>tput lines</code> and return its output</li>
<li>Otherwise, if the command <code>stty</code> exists, run <code>stty size</code> and parse its output for the value</li>
<li>Otherwise, return a sensible default.</li>
</ul>


<p>How does this apply to our lookup table?  Essentially we want a table of conditions and, for the first one that holds, perform
the calculation to figure out the size.  For the sake of clarity, we&#8217;ll assume some helper methods, which gives us this code:</p>

<figure class='code'><figcaption><span>Good ole if/elsif/else</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">terminal_columns</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;COLUMNS&#39;</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/^\s+$/</span>
</span><span class='line'>    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;COLUMNS&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">command_exists?</span><span class="p">(</span><span class="s2">&quot;tput&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="sb">`tput lines`</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">command_exists?</span><span class="p">(</span><span class="s2">&quot;stty&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">parse_stty</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="no">DEFAULT_COLUMNS</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a pretty complex routine.  What if we need to add Windows support?  Another <code>elsif</code>.  Lets use our newfound lookup table
powers, but instead of using a static key for lookup, we&#8217;ll use a dynamic one, based on our conditions:</p>

<figure class='code'><figcaption><span>Ordered lookup</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">TERMINAL_SIZES</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>  <span class="p">{</span> <span class="ss">:test</span> <span class="o">=&gt;</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;COLUMNS&#39;</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/^\s+$/</span> <span class="p">},</span> <span class="ss">:val</span> <span class="o">=&gt;</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;COLUMNS&#39;</span><span class="o">]</span> <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span> <span class="ss">:test</span> <span class="o">=&gt;</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="n">command_exists?</span><span class="p">(</span><span class="s2">&quot;tput&quot;</span><span class="p">)</span> <span class="p">},</span>   <span class="ss">:val</span> <span class="o">=&gt;</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="sb">`tput lines`</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span> <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span> <span class="ss">:test</span> <span class="o">=&gt;</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="n">command_exists?</span><span class="p">(</span><span class="s2">&quot;stty&quot;</span><span class="p">)</span> <span class="p">},</span>   <span class="ss">:val</span> <span class="o">=&gt;</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="n">parse_stty</span> <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span> <span class="ss">:test</span> <span class="o">=&gt;</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="kp">true</span> <span class="p">},</span>                      <span class="ss">:val</span> <span class="o">=&gt;</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="no">DEFAULT_COLUMNS</span> <span class="p">},</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that we&#8217;re using an array to keep things ordered, but we&#8217;re using an <code>Array</code> of <code>Hash</code> so that our client code will be
fairly readable (we&#8217;ll see that in a second).</p>

<p>Recall that we want the first expression that returns true, and to return the value associated with that expression.  This is a
one-liner, thanks to Ruby&#8217;s aweomse collections:</p>

<figure class='code'><figcaption><span>Holy functional programming, Batman!</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">terminal_columns</span>
</span><span class='line'>  <span class="no">TERMINAL_SIZES</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">size</span><span class="o">|</span> <span class="n">size</span><span class="o">[</span><span class="ss">:test</span><span class="o">].</span><span class="n">call</span> <span class="p">}</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="ss">:val</span><span class="o">].</span><span class="n">call</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not bad.</p>

<p>Now, if you come across something like this, but didn&#8217;t derive it as we have done here, is it really better?  I would argue that
it is, especially if you are comfortable with the general concept of table-driven algorithms.  In the case of our credit card
example, you can see a clear mapping between special cases and the results.  For the terminal lines example here, we again have a
clean mapping between test and result, and it&#8217;s not muddied up amongst control structures.</p>

<p>These tables are also more easily changed: new cases can be added to our credit card type table, and we can easily re-order our
terminal size calculation if we decide on a better strategy.</p>

<p>If you find yourself writing an <code>elsif</code> or a <code>case</code> statement; consider using a table-driven method.  Ruby provides excellent
tools to make this easy to do for any use case.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[† What Makes an Awesome Command-Line App?]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/05/02/what-makes-and-awesome-command-line-app.html"/>
    <updated>2012-05-02T09:40:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/05/02/what-makes-and-awesome-command-line-app</id>
    <content type="html"><![CDATA[<p>I wrote an article in the latest <a href="http://pragprog.com/magazines/2012-05/content">PragPub magazine</a> called <a href="http://pragprog.com/magazines/2012-05/what-makes-an-awesome-commandline-application">What Makes an Awesome Command-line Application?</a>.  Check it out!  If you want a more code-focused and detailed version, see <a href="http://www.naildrivin5.com/blog/2012/04/01/the-nine-facets-of-an-awesome-command-line-app.html">The Nine Facets of an Awesome Command-Line App</a> and, of course, <a href="http://www.pragprog.com/titles/dccar">my book</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[&#10106;&#10144; Five Months of eBook Sales]]></title>
    <link href="http://www.naildrivin5.com/blog/2012/04/24/five-months-of-ebook-sales.html"/>
    <updated>2012-04-24T10:00:00-04:00</updated>
    <id>http://www.naildrivin5.com/blog/2012/04/24/five-months-of-ebook-sales</id>
    <content type="html"><![CDATA[<p>I really enjoyed reading <a href="http://www.twitter.com/jstorimer">Jesse Storimer&#8217;s</a> recent post, <a href="http://jstorimer.com/2012/04/20/4-months-of-ebook-sales.html">4 Months of ebook Sales</a>, about the sales of his book <a href="http://workingwithunixprocesses.com/">&#8220;Working with Unix Processes&#8221;</a>.  His feelings echo my own regarding my book, <a href="http://pragprog.com/titles/dccar/">&#8220;Build Awesome Command-Line Applications in Ruby&#8221;</a>:</p>

<blockquote><p>I&#8217;m ecstatic with the results so far, but I have no idea how they compare.</p><footer><strong>Jesse Storimer,</strong> <cite><a href='http://jstorimer.com/2012/04/20/4-months-of-ebook-sales.html'>jstorimer.com/2012/04/20/&hellip;</a></cite></footer></blockquote>


<p>Our books complement each other quite well, and came out around the same time.  He wrote his largely on his own, going the self-publishing route, while I wrote mine with the <a href="http://pragprog.com/">Pragmatic Programmers</a>.  I thought I&#8217;d write a similar piece from my experience going the &#8220;traditional&#8221; route.</p>

<!-- more -->


<h3>Beginning</h3>

<p>I wrote an initial draft of &#8220;Build Awesome Command-Line Applications in Ruby&#8221; over November 2010, as part of <a href="http://forums.pragprog.com/forums/235">PragProWriMo</a>.  I
wrote almost every day, and had about 170 pages of Markdown written at the end.  I hadn&#8217;t thought too far ahead, but in January of 2011, I decided to submit it to the Prags and see if they were interested.</p>

<p>To my surprise and excitement they decided to go forward with it!  I had no idea what to expect, but figured that since I had a good 75% of a &#8220;real&#8221; book done, it shouldn&#8217;t be too much more work for me to finish up the first draft and clean it up.  Boy was I wrong.</p>

<p>I spent the next 11 months on the book, reaching &#8220;done&#8221; by February of this year.  That may seem like a long time (it certainly did to me).  The reason it took &#8220;so long&#8221; was entirely due to working with a publisher and editor, but I don&#8217;t mean that as a negative.  It actually <em>needed</em> to take that long, and the book I shipped was markedly better than anything I would&#8217;ve done on my own.</p>

<h3>Developing</h3>

<p>The Prags don&#8217;t just take your manuscript, spell-check it and ship it.  They assign a <em>development editor</em> to each book.  I had no idea what this was; I thought editors fixed spelling and grammar mistakes.  Instead, John Osborn, my editor, provided deep and insightful feedback on every aspect of the book.  Did the sections flow together?  Are the titles consistent? Did the examples make sense?  Of course, I had created plenty of passive voice, subject/verb disagreement and other &#8220;advanced grammar mishaps&#8221; to keep John quite busy.</p>

<p>Identifying these issues in your own work is hard.  It&#8217;s also just not possible to get real, usable feedback on your work.
Friends and colleagues just won&#8217;t give you the brutal, honest feedback you sometimes need.  It had been a long time since I&#8217;ve
been given this sort of feedback, and it hurt a bit (at first) to read comments like these:</p>

<ul>
<li>&#8220;The overall premise of the book is not immediately clear.&#8221;</li>
<li>&#8220;The audience level remains unclear.&#8221;</li>
<li>&#8220;After a while&#8230;it just gets wearing. Why should I bother to read yet one more example when I know that I’ll be told this was the wrong way to do it?&#8221;</li>
</ul>


<p>These came after John and I had spent a lot of time working my initial manuscript into something publishable, and had gotten a
lot of positive feedback from the tech reviewers.  Based on the publisher feedback, we were looking at an almost total rewrite, and I wasn&#8217;t too happy about it.  But, I really believed in the book and wasn&#8217;t about to quit now, so I trusted the publishers.  Recognizing their experience, I treated this as a learning opportunity.  So we persevered.</p>

<h3>Persevering</h3>

<p>Three chapters later, it was so clear to me that I had been wrong that I couldn&#8217;t believe I had felt otherwise.   And, I never would&#8217;ve gotten there without such honest feedback and a literal <em>team</em> of professionals<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup> working to make my book
as good as it could be.  In the end, the book bears little resemblance to what I had produced during PragProWriMo, and, while I
probably could&#8217;ve gotten that into a &#8220;sellable&#8221; shape, it would not have been nearly as good.</p>

<p>So, a total of 15 months of work, including an almost total rewrite, all on my own time, with no money up front.  Was it worth
it? Absolutely. But, how has it been selling?</p>

<p>On the one hand, I&#8217;m not sure.  I don&#8217;t know how many copies of my book will &#8220;pay for&#8221; the development costs, or how many will
make the publishers &#8220;happy&#8221; with the result (I&#8217;ve put off asking in case the answer is &#8220;way more than you&#8217;ve sold&#8221;).  I do know that I&#8217;ve sold more than I thought I would, and although I&#8217;d love to sell
more, I&#8217;m really happy with how it&#8217;s done.</p>

<h3>Performing</h3>

<p>As of this post, I&#8217;ve sold around 3,000 copies from the Pragmatic Programmers online store<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>.  I don&#8217;t yet know how many I&#8217;ve sold from other channels such as Amazon or Barnes &amp; Noble &#8211; hopefully a lot &#8211; but sales from the Prags&#8217; store alone feels like more than I was expecting.</p>

<p>Of course, I don&#8217;t make as much per book as Jesse does<sup id='fnref:3'><a href='#fn:3' rel='footnote'>3</a></sup>; that team I mentioned doesn&#8217;t come free.  But, being featured on the Pragmatic Programmers&#8217; website is unbeatable promotion.  This certainly drove a lot of sales.  It&#8217;s my hope that sales are higher than they would&#8217;ve been had the Prags published a version of the book I had originally written, but there&#8217;s no way to know for sure.</p>

<p>Now, I don&#8217;t mean to imply Jesse&#8217;s book is poorly written; it&#8217;s not at all.  Would it be better if it were edited professionally?
I suppose that depends on what you mean?  Would it be better <em>written</em>?  Certainly; most writing improves with editing and revising.
Would it have sold more?  Would it have sold enough to cover the costs and time of editing?  Again, there&#8217;s no way to know.</p>

<p>So where does this leave us?  I know that working with John and the Prags has made me a better writer, but would I be confident enough to &#8220;go it alone&#8221;?   Given my lack of notability, I feel I benefit greatly from having my work published and distributed by the Prags.  Further, knowing my writing style and abilities as I do, my work will be much higher quality with a team of professionals in my corner.</p>

<p>That being said, I&#8217;d still love to try self-publishing at some point, but I&#8217;d really love to read a book by Jesse developed with the Pragmatic Programmers.</p>

<hr />

<div class="footnotes">
    <ol>
        <li id='fn:1'>In addition to John, Dave, and Andy, the Prags employ copy editors, sysadmins, indexers, and probably many others that I don&#8217;t even know about that turn my XML and code into a beautiful book to read on paper as well as every reading device there is. <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>The breakdown is about 10% paper/90% electronic, which seems about right. <a href='#fnref:2' rev='footnote'>↩</a></li><li id='fn:3'>It&#8217;s worth pointing out that the Prag&#8217;s contract is <strong>very</strong> generous compared to most other publishers. <a href='#fnref:3' rev='footnote'>↩</a></li>
    </ol>
</div>



]]></content>
  </entry>
  
</feed>
